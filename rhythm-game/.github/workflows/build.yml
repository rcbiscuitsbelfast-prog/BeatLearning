name: Build and Deploy Rhythm Game

on:
  push:
    branches: [ main ]
    paths:
      - 'rhythm-game/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'rhythm-game/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Godot
      uses: chickensoft-games/godot-action@v1
      with:
        version: 4.2.1
        export-templates: true

    - name: Install export templates
      run: |
        mkdir -p ~/.local/share/godot/export_templates
        wget -O /tmp/templates.zip https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_export_templates.tpz
        unzip -q /tmp/templates.zip -d ~/.local/share/godot/export_templates/
        mv ~/.local/share/godot/export_templates/templates ~/.local/share/godot/export_templates/4.2.1.stable

    - name: Create export preset file
      working-directory: ./rhythm-game
      run: |
        cat > export_presets.cfg << 'EOF'
[preset.0]

name="HTML5"
platform="Web"
runnable=true
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="build/web/index.html"
encryption_include_filters=""
encryption_exclude_filters=""
encrypt_pck=false
encrypt_directory=false

[preset.0.options]

variant/html5/cookie_banner_enabled=true
variant/html5/canvas_resizing_policy=2
variant/html5/draggable_window_enabled=false
variant/html5/experimental_vram_cache=false
variant/html5/export_icon=true
variant/html5/focus_icon_on_start=true
variant/html5/head_include=""
variant/html5/html_include=""
variant/html5/progress_bar_enabled=true
variant/html5/stretch_mode=2
variant/html5/thread_support=true
variant/html5/vibrate_navigation_enabled=true
variant/html5/webxr_emulated_tracking=false
variant/html5/webxr_enabled=false
variant/html5/webxr_mode=0
variant/html5/webxr_regular_input=true

[preset.1]

name="Windows Desktop"
platform="Windows Desktop"
runnable=true
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="build/windows/RhythmGame.exe"
encryption_include_filters=""
encryption_exclude_filters=""
encrypt_pck=false
encrypt_directory=false

[preset.1.options]

binary_format/embed_pck=false
debug/export_console_wrapper=1
binary_format/architecture="x86_64"
codesign/codesign_enabled=false
codesign/certificate_file=""
codesign/certificate_password=""
codesign/identity=""
codesign/description=""
codesign/custom_options=PackedStringArray()
application/modify_resources=true
application/icon=""
application/console_wrapper_icon=""
application/icon_interpolation=4
application/file_version=""
application/product_version=""
application/company_name=""
application/product_name=""
application/file_description=""
application/copyright=""
application/trademarks=""
application/export_angle=0

[preset.2]

name="Linux/X11"
platform="Linux/X11"
runnable=true
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="build/linux/rhythm-game.x86_64"
encryption_include_filters=""
encryption_exclude_filters=""
encrypt_pck=false
encrypt_directory=false

[preset.2.options]

binary_format/embed_pck=false
debug/export_console_wrapper=1
ssh_remote_deploy/enabled=false
ssh_remote_deploy/host="user@host_ip"
ssh_remote_deploy/port="22"
ssh_remote_deploy/extra_args_ssh=""
ssh_remote_deploy/extra_args_scp=""
ssh_remote_deploy/run_script=""
ssh_remote_deploy/cleanup_script=""

[preset.3]

name="macOS"
platform="macOS"
runnable=true
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="build/macos/rhythm-game.zip"
encryption_include_filters=""
encryption_exclude_filters=""
encrypt_pck=false
encrypt_directory=false

[preset.3.options]

binary_format/architecture="universal"
debug/export_console_wrapper=1
application/icon=""
application/icon_interpolation=4
application/bundle_identifier=""
application/signature=""
application/app_category="Games"
application/short_version=""
application/version=""
application/copyright=""
application/copyright_localized={}
display/high_res=true
codesign/codesign_enabled=false
codesign/identity=""
codesign/certificate_file=""
codesign/certificate_password=""
codesign/entitlements/custom_file=""
codesign/entitlements/allow_jit_code_execution=false
codesign/entitlements/allow_unsigned_executable_memory=false
codesign/entitlements/allow_dyld_environment_variables=false
codesign/entitlements/disable_library_validation=false
codesign/entitlements/audio_input=false
codesign/entitlements/camera=false
codesign/entitlements/location=false
codesign/entitlements/address_book=false
codesign/entitlements/calendars=false
codesign/entitlements/photos_library=false
codesign/entitlements/apple_events=false
codesign/entitlements/debugging=false
codesign/entitlements/app_sandbox/enabled=false
codesign/entitlements/app_sandbox/network_server=false
codesign/entitlements/app_sandbox/network_client=false
codesign/entitlements/app_sandbox/device_usb=false
codesign/entitlements/app_sandbox/device_bluetooth=false
codesign/entitlements/app_sandbox/files_downloads=0
codesign/entitlements/app_sandbox/files_pictures=0
codesign/entitlements/app_sandbox/files_music=0
codesign/entitlements/app_sandbox/files_movies=0
codesign/entitlements/app_sandbox/helper_executables=[]
notarization/notarization_enabled=false
notarization/apple_id_name=""
notarization/apple_id_password=""
notarization/apple_team_id=""
privacy/microphone_usage_description=""
privacy/microphone_usage_description_localized={}
privacy/microphone_usage_description=""
privacy/microphone_usage_description_localized={}
privacy/location_usage_description=""
privacy/location_usage_description_localized={}
privacy/address_book_usage_description=""
privacy/address_book_usage_description_localized={}
privacy/calendar_usage_description=""
privacy/calendar_usage_description_localized={}
privacy/photos_library_usage_description=""
privacy/photos_library_usage_description_localized={}
privacy/desktop_folder_usage_description=""
privacy/desktop_folder_usage_description_localized={}
privacy/documents_folder_usage_description=""
privacy/documents_folder_usage_description_localized={}
privacy/downloads_folder_usage_description=""
privacy/downloads_folder_usage_description_localized={}
privacy/network_volumes_usage_description=""
privacy/network_volumes_usage_description_localized={}
privacy/removable_volumes_usage_description=""
privacy/removable_volumes_usage_description_localized={}
EOF

    - name: Create build directories
      working-directory: ./rhythm-game
      run: |
        mkdir -p build/web
        mkdir -p build/windows
        mkdir -p build/linux
        mkdir -p build/macos

    - name: Export HTML5 version
      working-directory: ./rhythm-game
      run: |
        godot --headless --export-release "HTML5" build/web/index.html

    - name: Export Windows version
      working-directory: ./rhythm-game
      run: |
        godot --headless --export-release "Windows Desktop" build/windows/RhythmGame.exe

    - name: Export Linux version
      working-directory: ./rhythm-game
      run: |
        godot --headless --export-release "Linux/X11" build/linux/rhythm-game.x86_64

    - name: Export macOS version
      working-directory: ./rhythm-game
      run: |
        godot --headless --export-release "macOS" build/macos/rhythm-game.zip

    - name: Upload HTML5 build artifact
      uses: actions/upload-artifact@v3
      with:
        name: html5-build
        path: ./rhythm-game/build/web/
        retention-days: 30

    - name: Upload Windows build artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: ./rhythm-game/build/windows/RhythmGame.exe
        retention-days: 30

    - name: Upload Linux build artifact
      uses: actions/upload-artifact@v3
      with:
        name: linux-build
        path: ./rhythm-game/build/linux/rhythm-game.x86_64
        retention-days: 30

    - name: Upload macOS build artifact
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: ./rhythm-game/build/macos/rhythm-game.zip
        retention-days: 30

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./rhythm-game/build/web
        destination_dir: rhythm-game

    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        name: Rhythm Game Build
        body: |
          Automated build of the Rhythm Game.

          ## Download Links
          - **Windows**: Download `RhythmGame.exe` from the artifacts below
          - **Linux**: Download `rhythm-game.x86_64` from the artifacts below
          - **macOS**: Download `rhythm-game.zip` from the artifacts below
          - **Web**: Play online at [GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/rhythm-game/)

          ## How to Play
          1. Add MP3 files to `src/assets/audio/`
          2. Add corresponding .osu beatmap files to `src/assets/beatmaps/`
          3. Launch the game and select a song
          4. Use D, F, J, K keys to hit the notes

          ## BeatLearning Integration
          This game is designed to work with BeatLearning-generated beatmaps. Use the BeatLearning repository to generate OSU beatmaps from your MP3 files.
        files: |
          ./rhythm-game/build/windows/RhythmGame.exe
          ./rhythm-game/build/linux/rhythm-game.x86_64
          ./rhythm-game/build/macos/rhythm-game.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}